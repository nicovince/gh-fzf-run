#!/usr/bin/env bash
set -e

function help()
{
    cat <<EOF
Select with fzf a workflow from GitHub Actions to view, watch, cancel.
Usage:
  gh fzf-run [action]

Actions:
  Any actions supported by 'gh run' which takes a workflow id as parameter

Flags:
  -R, --repo OWNER/REPO\tSelect another repository.
  -b, --branch\tFilter runs by branch
  -w, --workflow\tFilter runs by workflow
  -h, --help\tShow help for command
EOF
}

REPO=""
LIST_OPT=()
while [ $# -gt 0 ]; do
    key="$1"
    case ${key} in
        -h|--help)
            help
            exit 0
            ;;

        -b|--branch)
            LIST_OPT+=(--branch ${2@Q})
            shift
            ;;
        -w|--workflow)
            LIST_OPT+=(--workflow ${2@Q})
            shift
            ;;
        -R|--repository)
            REPO="$2"
            shift
            ;;
        --)
            ACTION_ARGS="${@:2:$#}"
            break
            ;;
        *)
            PARAMS="${PARAMS} ${1}"
            ;;
    esac
    shift
done
eval set -- "${PARAMS}"
if [ -z "$1" ]; then
    ACTION="view"
else
    ACTION="$1"
fi

if [ -z "${REPO}" ]; then
    repo_owner="$(git remote -v | head -1 | awk '{print $2}' | rev | cut -d '/' -f 2 | rev )"
    repo_name="$(git remote -v | head -1 | awk '{print $2}' | rev | cut -d '/' -f 1 | rev | cut -d '.' -f 1)"
    REPO="${repo_owner}/${repo_name}"
fi
REPO_OPT="-R ${REPO}"
RUN_OPT="${REPO_OPT}"

# Check dependencies are available
if ! type -p fzf >/dev/null; then
  echo "fzf not found on the system" >&2
  exit 1
fi

JSON_FIELDS="status,conclusion,displayTitle,workflowName,headBranch,event,createdAt,databaseId"
TITLES='["STATUS", "CONCLUSION", "WORKFLOW", "TITLE", "BRANCH", "EVENT", "TIMESTAMP", "ID"]'
FIELDS="[.status, .conclusion, .workflowName, .displayTitle, .headBranch, .event, .createdAt, .databaseId]"

case ${ACTION} in
    cancel|watch)
        JQ_FILTER=".[] | [select(.status | test(\"completed\") | not)] |"
        ;;
    delete|download|rerun)
        JQ_FILTER=".[] | [select(.status | test(\"completed\"))] |"
        ;;
    view)
        JQ_FILTER=""
        ;;
    *)
        echo "Unknown action ${ACTION}"
        exit 1
esac

function get_wf_id()
{
    echo "$@" | rev | awk '{print $1}' | rev
}

export REPO
export -f get_wf_id
QUERY="(${TITLES}), (map (select(.conclusion ==\"\").conclusion=\"inprogress\") | ${JQ_FILTER} (.[] | ${FIELDS})) | @tsv"
LIST_OPT+=(--json ${JSON_FIELDS})
export FZF_DEFAULT_COMMAND="gh run ${REPO_OPT} list ${LIST_OPT[@]} --jq '${QUERY}' | column -ts $'\t'"
#wf_sel=$(fzf --bind "ctrl-r:reload#${FZF_DEFAULT_COMMAND}#" -0 --header-lines=1 --multi | jq -r -R -s 'split("\n") | [ .[] | select(length > 0)]')
fzf --bind "ctrl-r:reload#${FZF_DEFAULT_COMMAND}#" \
    --bind "ctrl-a:execute(get_wf_id {} | xargs gh run -R ${REPO} cancel)" \
    --bind 'ctrl-w:execute(get_wf_id {} | xargs gh run -R ${REPO} watch)' \
    --bind "ctrl-v:execute(get_wf_id {} | xargs gh run -R ${REPO} view | less -R)" \
    --bind "ctrl-j:execute(echo 'job view {}' >> cmds.txt)" \
    --header "ctrl-r: reload; ctrl-a: abort workflow" \
    -0 --header-lines=1 --print-query
